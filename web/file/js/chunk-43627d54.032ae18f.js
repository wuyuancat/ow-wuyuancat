(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-43627d54"],{"1c24":function(e,t,a){"use strict";a.r(t);var s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("a-spin",{attrs:{spinning:e.confirmLoading}},[a("j-form-container",{attrs:{disabled:e.formDisabled}},[a("a-form",{attrs:{slot:"detail",form:e.form},slot:"detail"},[a("a-row",[a("a-col",{attrs:{span:24}},[a("a-form-item",{attrs:{label:"素材类型",labelCol:e.labelCol,wrapperCol:e.wrapperCol}},[a("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["assetType",e.validatorRules.assetType],expression:"['assetType', validatorRules.assetType]"}],on:{change:e.assetTypeChange}},[a("a-select-option",{attrs:{value:1}},[e._v("背景")]),a("a-select-option",{attrs:{value:2}},[e._v("声音")]),a("a-select-option",{attrs:{value:3}},[e._v("造型")]),a("a-select-option",{attrs:{value:4}},[e._v("角色")])],1)],1)],1),void 0!==e.model.assetType?a("div",[a("a-col",{attrs:{span:24}},[a("a-form-item",{attrs:{label:"素材名",labelCol:e.labelCol,wrapperCol:e.wrapperCol}},[a("a-input",{directives:[{name:"decorator",rawName:"v-decorator",value:["assetName",e.validatorRules.assetName],expression:"['assetName', validatorRules.assetName]"}],attrs:{placeholder:"请输入素材名"},on:{change:e.generateJsonData}})],1)],1),a("a-col",{attrs:{span:24}},[a("a-form-item",{attrs:{label:"素材文件",labelCol:e.labelCol,wrapperCol:e.wrapperCol}},[4!=e.model.assetType?a("j-upload",{directives:[{name:"decorator",rawName:"v-decorator",value:["md5Ext",e.validatorRules.md5Ext],expression:"['md5Ext', validatorRules.md5Ext]"}],attrs:{uploadPath:e.assetPrefix,fileType:e.fileType,number:1,"trigger-change":!0},on:{selected:e.selectedAsset}}):e._e(),4==e.model.assetType?a("a-collapse",{attrs:{activeKey:["1","2"]}},[a("a-collapse-panel",{key:"1",attrs:{header:"造型"}},[a("j-upload",{attrs:{uploadPath:e.assetPrefix,fileType:"image",number:99,"trigger-change":!0},on:{selected:e.selectedCostume,delete:e.onCostumeDelete},model:{value:e.costumFile,callback:function(t){e.costumFile=t},expression:"costumFile"}})],1),a("a-collapse-panel",{key:"2",attrs:{header:"声音"}},[a("j-upload",{attrs:{uploadPath:e.assetPrefix,number:99,"trigger-change":!0},on:{selected:e.selectedSound,delete:e.onSoundDelete},model:{value:e.soundFile,callback:function(t){e.soundFile=t},expression:"soundFile"}})],1)],1):e._e()],1)],1),a("a-col",{attrs:{span:24}},[a("a-form-item",{attrs:{label:"标签",labelCol:e.labelCol,wrapperCol:e.wrapperCol}},[a("j-category-select",{attrs:{pcode:e.scratchTagCode,returnValue:"",multiple:"",placeholder:"请选择标签"},model:{value:e.model.tags,callback:function(t){e.$set(e.model,"tags",t)},expression:"model.tags"}})],1)],1),a("a-col",{attrs:{span:24}},[a("a-form-item",{attrs:{label:"素材json数据",labelCol:e.labelCol,wrapperCol:e.wrapperCol}},[a("j-code-editor",{ref:"codeEditor",staticStyle:{"min-height":"100px"},attrs:{language:"json",placeholder:"自动生成索引数据",fullScreen:!1},model:{value:e.model.assetData,callback:function(t){e.$set(e.model,"assetData",t)},expression:"model.assetData"}})],1)],1)],1):e._e(),e.showFlowSubmitButton?a("a-col",{staticStyle:{"text-align":"center"},attrs:{span:24}},[a("a-button",{on:{click:e.submitForm}},[e._v("提 交")])],1):e._e()],1)],1)],1)],1)},n=[],o=a("0fea"),r=a("88bc"),i=a.n(r),l=(a("ca00"),a("c681")),c=a("2dab"),u=a("fe54"),d=a("c14a"),m=a("7b16"),f=a("a876"),p=a("cf74"),h=a("49a8"),g={name:"TeachingScratchAssetsForm",components:{JFormContainer:l["default"],JDate:c["default"],JSelectDepart:u["default"],JSelectUserByDep:d["default"],JDictSelectTag:m["default"],JCodeEditor:f["default"],JUpload:p["default"],JCategorySelect:h["default"]},props:{formData:{type:Object,default:function(){},required:!1},formBpm:{type:Boolean,default:!1,required:!1},disabled:{type:Boolean,default:!1,required:!1}},data:function(){return{form:this.$form.createForm(this),model:{},labelCol:{xs:{span:24},sm:{span:5}},wrapperCol:{xs:{span:24},sm:{span:16}},confirmLoading:!1,validatorRules:{md5Ext:{rules:[{required:!0,message:"请上传素材文件!"}]},assetName:{rules:[{required:!0,message:"请输入素材名!"}]},assetType:{rules:[{required:!0,message:"请输入素材类型!"}]},assetRole:{rules:[{required:!0,message:"请输入权限分类!"}]}},url:{add:"/teaching/teachingScratchAssets/add",edit:"/teaching/teachingScratchAssets/edit",queryById:"/teaching/teachingScratchAssets/queryById"},scratchTagCode:"",assetPrefix:"/internalapi/asset/",costumFile:"",soundFile:"",fileType:"file",assetData:{name:"",tags:[]}}},computed:{formDisabled:function(){return!0===this.formBpm?!1!==this.formData.disabled:this.disabled},showFlowSubmitButton:function(){return!0===this.formBpm&&!1===this.formData.disabled}},created:function(){},watch:{"model.tags":{handler:function(e,t){this.assetData["tags"]=e?this.model.tags.split(","):[],this.generateJsonData()}},"model.assetType":{handler:function(e,t){switch(this.fileType="1"==e||"3"==e?"image":"file",e){case 1:this.scratchTagCode="A03A01";break;case 2:this.scratchTagCode="A03A02";break;case 3:this.scratchTagCode="A03A03";break;case 4:this.scratchTagCode="A03A03";break}}}},methods:{add:function(){this.edit({})},edit:function(e){var t=this;this.form.resetFields(),this.model=Object.assign({},e),this.visible=!0,this.model.assetData&&(this.parseJsonData(this.model.assetType,this.model.assetData),this.generateJsonData()),this.$nextTick((function(){t.form.setFieldsValue(i()(t.model,"assetType","assetName","assetData","md5Ext","tags","createBy","createTime"))}))},assetTypeChange:function(e){this.model={},this.model.assetType=parseInt(e),this.clearAssetInfo(),this.form.resetFields(),this.generateJsonData()},onSoundDelete:function(e){for(var t=0;t<this.assetData.sounds.length;t++)e.includes(this.assetData.sounds[t].assetId)&&(this.assetData.sounds.splice(t,1),this.generateJsonData())},onCostumeDelete:function(e){for(var t=0;t<this.assetData.costumes.length;t++)e.includes(this.assetData.costumes[t].assetId)&&(this.assetData.costumes.splice(t,1),this.generateJsonData())},selectedAsset:function(e,t){var a=this,s={};s["name"]=t.name.split(".")[0],s["md5ext"]=e.replace(this.assetPrefix,""),s["assetId"]=s["md5ext"].split(".")[0],s["dataFormat"]=s["md5ext"].split(".")[1];var n=t.type;if(n.startsWith("image"))this.getImageInfo(t).then((function(e){a.assetData=Object.assign(a.assetData,s,e),a.generateJsonData()}));else{if(!n.startsWith("audio"))return void this.$message.info("不支持的文件类型");this.getSoundInfo(t).then((function(e){a.assetData=Object.assign(a.assetData,s,e),a.generateJsonData()}))}this.model.assetName||(this.model.assetName=t.name.split(".")[0],this.$nextTick((function(){a.form.setFieldsValue({assetName:a.model.assetName})})),this.generateJsonData())},selectedCostume:function(e,t){var a=this,s={};s["name"]=t.name.split(".")[0],s["md5ext"]=e.replace(this.assetPrefix,""),s["assetId"]=s["md5ext"].split(".")[0],s["dataFormat"]=s["md5ext"].split(".")[1],this.getImageInfo(t).then((function(e){var t=Object.assign(s,e);a.assetData["costumes"]=a.assetData["costumes"]||[],a.assetData["costumes"].push(t),a.generateJsonData()}))},selectedSound:function(e,t){var a=this,s={};s["name"]=t.name.split(".")[0],s["md5ext"]=e.replace(this.assetPrefix,""),s["assetId"]=s["md5ext"].split(".")[0],s["dataFormat"]=s["md5ext"].split(".")[1],this.getSoundInfo(t).then((function(e){var t=Object.assign(s,e);a.assetData["sounds"]=a.assetData["sounds"]||[],a.assetData["sounds"].push(t),a.generateJsonData()}))},getSoundInfo:function(e){return this.fileType="file",new Promise((function(t,a){var s=new FileReader;s.readAsArrayBuffer(e),s.onload=function(){var e=new AudioContext;e.decodeAudioData(s.result,(function(e){t({sampleCount:e.length,rate:e.sampleRate})}))}}))},getImageInfo:function(e){this.fileType="image";var t=e.name.split(".").pop();return new Promise((function(a,s){var n=new FileReader;n.readAsDataURL(e),n.onload=function(){var e=new Image;e.src=n.result,e.onload=function(){a({rotationCenterY:parseInt(e.height/2),rotationCenterX:parseInt(e.width/2),bitmapResolution:"svg"==t?1:2})}}}))},parseJsonData:function(e,t){var a=this;this.assetData=JSON.parse(t),4==e&&(this.soundFile=this.assetData.sounds.map((function(e){return a.assetPrefix+e.md5ext})).join(","),this.costumFile=this.assetData.costumes.map((function(e){return a.assetPrefix+e.md5ext})).join(","))},generateJsonData:function(){var e=this,t=this;this.$nextTick((function(){if(e.assetData["name"]=e.form.getFieldValue("assetName")||e.model.assetName,4==e.model.assetType&&(e.assetData["isStage"]=!1,e.assetData["variables"]={},e.assetData["blocks"]={},e.assetData["sounds"]=e.assetData["sounds"]||[],e.assetData["costumes"]=e.assetData["costumes"]||[],e.assetData["costumes"])){var a=[];e.assetData["costumes"].forEach((function(e){a.push(t.assetPrefix+e.md5ext)})),e.model.md5Ext=a.join(",")}var s=JSON.stringify(e.assetData);e.model.assetData=s,e.$refs.codeEditor.setCodeContent(s)}))},clearAssetInfo:function(){this.costumFile="",this.soundFile="",this.fileType="file",this.assetData={name:"",tags:[]}},submitForm:function(){var e=this,t=this;4!=this.model.assetType||void 0!==this.assetData["costumes"]?this.form.validateFields((function(a,s){if(!a){t.confirmLoading=!0;var n="",r="";e.model.id?(n+=e.url.edit,r="put"):(n+=e.url.add,r="post");var i=Object.assign(e.model,s);Object(o["j"])(n,i,r).then((function(e){e.success?(t.clearAssetInfo(),t.$message.success(e.message),t.$emit("ok")):t.$message.warning(e.message)})).finally((function(){t.confirmLoading=!1}))}})):t.$message.warning("角色必须上传一个造型")}}},b=g,v=a("2877"),D=Object(v["a"])(b,s,n,!1,null,null,null);t["default"]=D.exports},"88bc":function(e,t,a){(function(t){var a=1/0,s=9007199254740991,n="[object Arguments]",o="[object Function]",r="[object GeneratorFunction]",i="[object Symbol]",l="object"==typeof t&&t&&t.Object===Object&&t,c="object"==typeof self&&self&&self.Object===Object&&self,u=l||c||Function("return this")();function d(e,t,a){switch(a.length){case 0:return e.call(t);case 1:return e.call(t,a[0]);case 2:return e.call(t,a[0],a[1]);case 3:return e.call(t,a[0],a[1],a[2])}return e.apply(t,a)}function m(e,t){var a=-1,s=e?e.length:0,n=Array(s);while(++a<s)n[a]=t(e[a],a,e);return n}function f(e,t){var a=-1,s=t.length,n=e.length;while(++a<s)e[n+a]=t[a];return e}var p=Object.prototype,h=p.hasOwnProperty,g=p.toString,b=u.Symbol,v=p.propertyIsEnumerable,D=b?b.isConcatSpreadable:void 0,y=Math.max;function x(e,t,a,s,n){var o=-1,r=e.length;a||(a=j),n||(n=[]);while(++o<r){var i=e[o];t>0&&a(i)?t>1?x(i,t-1,a,s,n):f(n,i):s||(n[n.length]=i)}return n}function w(e,t){return e=Object(e),C(e,t,(function(t,a){return a in e}))}function C(e,t,a){var s=-1,n=t.length,o={};while(++s<n){var r=t[s],i=e[r];a(i,r)&&(o[r]=i)}return o}function T(e,t){return t=y(void 0===t?e.length-1:t,0),function(){var a=arguments,s=-1,n=y(a.length-t,0),o=Array(n);while(++s<n)o[s]=a[t+s];s=-1;var r=Array(t+1);while(++s<t)r[s]=a[s];return r[t]=o,d(e,this,r)}}function j(e){return S(e)||A(e)||!!(D&&e&&e[D])}function F(e){if("string"==typeof e||E(e))return e;var t=e+"";return"0"==t&&1/e==-a?"-0":t}function A(e){return I(e)&&h.call(e,"callee")&&(!v.call(e,"callee")||g.call(e)==n)}var S=Array.isArray;function J(e){return null!=e&&O(e.length)&&!k(e)}function I(e){return P(e)&&J(e)}function k(e){var t=N(e)?g.call(e):"";return t==o||t==r}function O(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=s}function N(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function P(e){return!!e&&"object"==typeof e}function E(e){return"symbol"==typeof e||P(e)&&g.call(e)==i}var R=T((function(e,t){return null==e?{}:w(e,m(x(t,1),F))}));e.exports=R}).call(this,a("c8ba"))}}]);